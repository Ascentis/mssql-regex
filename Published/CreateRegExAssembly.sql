/* Source code for the library at: https://github.com/Ascentis/mssql-regex */

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExIsMatch]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExIsMatch
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatch]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatch
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchIndexed]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchIndexed
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExSplit]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExSplit
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExReplace]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExReplace
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExReplaceCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExReplaceCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExEscape]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExEscape
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExUnescape]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExUnescape
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatches]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatches
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchGroup]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchGroup
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchGroupIndexed]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchGroupIndexed
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchesGroup]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchesGroup
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExCachedCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExCachedCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExClearCache]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExClearCache
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExExecCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExExecCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExResetExecCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExResetExecCount
GO

IF EXISTS (select *
	from sys.assembly_files f
	full outer join  sys.assemblies a
		on f.assembly_id=a.assembly_id
	where a.name ='Ascentis.RegExSQL')
	DROP ASSEMBLY [Ascentis.RegExSQL]
GO

IF EXISTS(SELECT *
		  from sys.configurations	
		  where name = 'clr strict security' and value = 0)
	EXEC SP_CONFIGURE 'clr strict security', 1
GO

RECONFIGURE
GO

DECLARE @clrName nvarchar(4000) = 'Ascentis.RegExSql';
DECLARE @asmBin varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C01030052299CBF0000000000000000E00022200B013000001C00000008000000000000F63A00000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000D4530000030060850000100000100000000010000010000000000000100000000000000000000000A13A00004F000000004000006C04000000000000000000000000000000000000006000000C0000001C3A0000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000FC1A000000200000001C000000020000000000000000000000000000200000602E727372630000006C0400000040000000060000001E0000000000000000000000000000400000402E72656C6F6300000C0000000060000000020000002400000000000000000000000000004000004200000000000000000000000000000000D53A0000000000004800000002000500902500000C140000090000000000000000000000000000009C39000080000000000000000000000000000000000000000000000000000000000000000000000056731100000A8001000004731200000A80020000042A00001330020026000000010000117F03000004281300000A260228030000060A0612016F1400000A2D08020673160000060B072A00001B30030065000000020000117E01000004156F1500000A7E020000040212006F1600000A2D3C7E01000004156F1700000A0B7E020000040212006F1600000A2D12731800000A0A7E0200000402066F1900000ADE1A7E0100000412016F1A00000ADCDE0B7E010000046F1B00000ADC062A000000011C0000020026002349000D0000000002000B004D58000B000000004A03027422000001731C00000A81160000012A001B30020022000000030000110328020000060A06026F1D00000A6F1E00000A0BDE0A062C06066F1F00000ADC072A000001100000020007000F16000A000000001B3003001E000000040000110328020000060A0602046F2000000A0BDE0A062C06066F1F00000ADC072A000001100000020007000B12000A000000001B3004001F000000040000110328020000060A060204056F2100000A0BDE0A062C06066F1F00000ADC072A0001100000020007000C13000A000000001B3002001D000000050000110328020000060A06026F2200000A0BDE0A062C06066F1F00000ADC072A00000001100000020007000A11000A000000001E02282300000A2A1E02282400000A2A1B30020022000000040000110328020000060A06026F1D00000A6F2500000A0BDE0A062C06066F1F00000ADC072A000001100000020007000F16000A000000001B3002003A000000060000110328020000060A06026F2600000A0B04076F2700000A2F0E07046F2800000A6F2500000A2B0572010000700CDE0A062C06066F1F00000ADC082A00000110000002000700272E000A000000001B3002002D000000040000110328020000060A06026F1D00000A6F2900000A046F2A00000A6F2500000A0BDE0A062C06066F1F00000ADC072A00000001100000020007001A21000A000000001B30020045000000060000110328020000060A06026F2600000A0B05076F2700000A2F1907056F2800000A6F2900000A046F2A00000A6F2500000A2B0572010000700CDE0A062C06066F1F00000ADC082A00000001100000020007003239000A000000001B3003004B000000050000110328020000060A06026F2600000A280100002B7E06000004252D17267E05000004FE061A000006732C00000A258006000004280200002B280300002B0BDE0A062C06066F1F00000ADC072A000110000002000700383F000A000000001B3003004500000007000011731C0000060A06047D080000040328020000060B07026F2600000A280100002B06FE061D000006732C00000A280200002B280300002B0CDE0A072C06076F1F00000ADC082A00000001100000020014002539000A000000001B30030044000000080000117E01000004156F1500000A7E020000047E07000004252D17267E05000004FE061B000006732F00000A258007000004280400002B0ADE0B7E010000046F1B00000ADC062A0110000002000B002C37000B000000001B3002002F000000080000117E020000046F3100000A0A7E01000004156F3200000A7E020000046F3300000ADE0B7E010000046F3400000ADC062A0001100000020016000C22000B0000000022FE137E030000042A42FE137E0300000416FE1380030000042A1E02283500000A2A4202031E283600000A02047D040000042A36027B04000004026F3700000A2A2E731900000680050000042A1E02283500000A2A1E036F2500000A2A360F01283800000A6F3900000A2A1E02283500000A2A5E036F2900000A027B080000046F2A00000A6F2500000A2A0042534A4201000100000000000C00000076342E302E33303331390000000005006C00000008070000237E0000740700009C07000023537472696E677300000000100F00000400000023555300140F0000100000002347554944000000240F0000E804000023426C6F62000000000000000200000157170208090A000000FA013300160000010000002900000005000000080000001D000000270000000100000039000000200000000800000007000000010000000400000003000000040000000000E00401000000000006002F03FD0506009C03FD0506004E02CB050F001D0600000600760214050600120314050600DE02140506008303140506004F03140506006803140506008D02140506006202DE0506004002DE050600C10214050600A802E1030600AC0609050600CF04D0030600C7000D0106009100E3060600C701FD050600A401D0030A00FB0341060A00FD029F050600AF0175060E00260556060E008D0756060600BB01090506002502FD050600B10009050E00270456060600B8000D010600C8000D0106002C01D0030600FE0309050E00810556060E00150256060E00360556061200B0018D05060083000D010600A3000D010E008806560600000000D9000000000001000100010000003801000041000100010004001000870700006900040016000321100009010000410005001800030110004D000000410008001C0031004D0445023100F604490211002E075602210046045B023600D50063021600250067021600010070020600870582025020000000009118C005850201006820000000009400FC01890201009C2000000000910032048F0202002C2100000000960075079902030040210000000096001804A102050080210000000096007F01A7020700BC210000000096004A07AE020A00F821000000009600BA06B6020E003422000000009600D201AB0010003C22000000009600E601AB00110044220000000096000504BD02120084220000000096004601C3021400DC220000000096005505C302170028230000000096006001CA021A008C230000000096002C06B6021E00F4230000000096006D05D202200058240000000096003907DA022300B8240000000096009401DA02230004250000000096001F07DA0223000D250000000096000B07DA0223001E25000000008618BA05060023002625000000008318BA05DE022300372500000000E6011D02060025004525000000009118C005850225005125000000008618BA050600250059250000000083002F00E902250061250000000083000B00EF0226006F25000000008618BA050600270077250000000083006300E9022700000001004605000001004605000001007D0702000200C705000001006F07000002004605000001006F0700000200460500000300CD06000001006F0700000200460500000300CD06000004006407000001006F07000002004605000001006F07000001006F07000001006F07000002004605000001006F07000002004605000003008107000001006F07000002004605000003008705000001006F07000002004605000003008705000004008107000001006F07000002004605000001006F0700000200460500000300870500000100460500000200470400000100120500000100470400000100120503006D000900BA0501001100BA0506001900BA050A002900BA0510003100BA0510003900BA0510004100BA0510004900BA0510005100BA0510005900BA0510006100BA0515006900BA0510007100BA0510007900BA051000B900BA050600E100BA0506008900BA0506000C00BA0506000901D906320014004E053F0089005B0401001C00C4035D008900BB0466001400BA0506001C0028016C008900A304740089006D040600B100BA051000D100270481001901A0068700D9001D020600D1008C019100D1008C019700D100C706A500D100DF01AB00D100F301AB002101BA03B000D1003906BC00C9000107C200C9000005C600F1009506CC0029010005D20031016A07D9002400BA05F3003101B306F9003101930719012C00BA05F30031011005490134000107C20089007F0401003400990506008900910406008100BA050600D100BA057B0114002D0483013C00BA03950114000107C2002E000B00FE022E00130007032E001B0026032E0023002F032E002B003D032E00330094032E003B009A032E0043002F032E004B00BA032E00530094032E005B0094032E006300D2032E006B00FC032E007300090483008300E104A0007B005704A3008300E104C0007B005704E0007B00570400017B007C0420017B00570440017B00570460017B00570480017B005704A0017B005704C0017B005704E0017B007C0400027B007C0420027B00570440027B00570460027B00570480027B005704270046007B008B009E00B4002B0134011A0038005100EB0038016A01890104800000010000000000020001000000A301E20000000400000000000000000000009A010001000000000400000000000000000000009A01F400000000000400000000000000000000009A010905000000000400000000000000000000009A010902000000000300020004000200050002005700E6005B0013015D00270161005C0100000000003C3E395F5F32305F30003C5265674578436163686564436F756E743E625F5F32305F30003C3E395F5F31385F30003C5265674578436F6D70696C65644D6174636865733E625F5F31385F30003C3E635F5F446973706C6179436C61737331395F30003C5265674578436F6D70696C65644D61746368657347726F75703E625F5F300049456E756D657261626C65603100436F6E63757272656E74537461636B60310049436F6C6C656374696F6E60310046756E636032004B657956616C7565506169726032004944696374696F6E6172796032003C3E39003C4D6F64756C653E00417363656E7469732E526567457853514C0053797374656D2E44617461006D73636F726C6962003C3E630053797374656D2E436F6C6C656374696F6E732E47656E657269630041646400496E7465726C6F636B6564005265674578436F6D70696C6564005265674578436F6D70696C65644D61746368496E6465786564005265674578436F6D70696C65644D6174636847726F7570496E6465786564005265674578436F6D70696C65645265706C616365005265674578436C6561724361636865004C6F636B436F6F6B69650049456E756D657261626C650049446973706F7361626C65004973566F6C6174696C65005265674578436F6D70696C6564457363617065005265674578436F6D70696C6564556E657363617065005265676578416371756972650053797374656D2E436F7265004361707475726500446973706F736500436F6D70696C657247656E65726174656441747472696275746500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C75650054727947657456616C75650053797374656D2E546872656164696E670053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E67005265674578436F6D70696C65644D61746368005265674578436F6D70696C656449734D61746368005075736800476574506F6F6C65645265676578537461636B005F737461636B005265676578506F6F6C4C6F636B00416371756972655265616465724C6F636B0052656C656173655265616465724C6F636B00416371756972655772697465724C6F636B0052656C656173655772697465724C6F636B00446F776E677261646546726F6D5772697465724C6F636B0055706772616465546F5772697465724C6F636B005265616465725772697465724C6F636B00417363656E7469732E526567457853514C2E646C6C005265676578506F6F6C006765745F4974656D0053797374656D0053756D0053797374656D2E5265666C656374696F6E004D61746368436F6C6C656374696F6E0047726F7570436F6C6C656374696F6E007061747465726E00547279506F70005265674578436F6D70696C65644D6174636847726F7570005265674578436F6D70696C65644D61746368657347726F75700067726F75700053797374656D2E4C696E7100436C656172004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F72007374720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F646573005265674578436F6D70696C65644D6174636865730053797374656D2E446174612E53716C54797065730053797374656D2E546578742E526567756C617245787072657373696F6E730053797374656D2E436F6C6C656374696F6E730052656765784F7074696F6E73006765745F47726F757073006765745F53756363657373004F626A6563740053656C656374005265674578436F6D70696C656453706C6974007265706C6163656D656E7400496E6372656D656E740053797374656D2E436F6C6C656374696F6E732E436F6E63757272656E74006765745F436F756E74005265674578526573657445786563436F756E7400526567457845786563436F756E74005F65786563436F756E74005265674578436163686564436F756E74005265674578436F6D70696C65645265706C616365436F756E7400636F756E74004361737400696E7075740046696C6C526F7700726F7700696E64657800506F6F6C6564526567657800546F417272617900000001000038625E2E47048148956D78ABD2DFDA1400042001010803200001052001011111042001010E04200101020C15128081020E15124D01120C0A070215124D01120C120C0500010810080615124D01120C062001021013000A070215124D01120C11550B151249020E15124D01120C082002021300101301052001115508072002011300130106200101101155050702120C0205200112790E03200002050702120C0E0520020E0E0E0620030E0E0E08060702120C12610520011D0E0E0400010E0E0320000E070703120C12650E05200112650E0320000805200112790805200012809506200112808D080C1001011512809D011E001261040A011279071512750212790E052002011C18191002021512809D011E011512809D011E00151275021E001E01050A0212790E0D1001011D1E001512809D011E00030A010E0807031214120C126103070108101512750215117D020E15124D01120C0812100102081512809D011E00151275021E00080D0A0115117D020E15124D01120C10151280A10115117D020E15124D01120C072002010E1180A50520010113000B15117D020E15124D01120C042000130108B77A5C561934E08980A00024000004800000940000000602000000240000525341310004000001000100FB9E4120118BC09271D4E040E3E458EC36CA202C6BD68AC96BB205FEAB82016B9F0060CF3B7C48FE32D100E6665381CA72EE115798079CB3ABF0C1914FF04590733A8B23E4E5103C532DF7D32E241E4D6170E06675240D008955E661AB9A7DA815D6E3086CE112FF90392E84F58EED4454439083B670906374EFE5B9B1938BB6030612450C06151249020E15124D01120C04061F5108070615124D01120C0306121008061512750212790E11061512750215117D020E15124D01120C0802060803000001050001120C0E09000115124D01120C0E070002011C101159050002020E0E0600030E0E0E0E0700040E0E0E0E0806000212610E0E0500020E0E0E0600030E0E0E080700040E0E0E080807000312610E0E08030000080A2002010E15124D01120C0520010E12790E20010815117D020E15124D01120C0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000000D010008526567457853514C000056010051436F6C6C656374696F6E206F662052656745782066756E6374696F6E7320746F2075736520696E204D5353514C202D2066756E6374696F6E732075736520526567457820436F6D70696C6564206D6F646500000501000000001F01001A417363656E74697320436F72706F726174696F6E2C20496E632E000017010012436F7079726967687420C2A920203230323000002901002433323930653164342D643931642D346635382D623636652D37383936346665333330653600000C010007312E302E302E3200004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E362E310100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E362E31240100020054020F497344657465726D696E69737469630154020949735072656369736501640100040054020F497344657465726D696E69737469630154020949735072656369736501540E1146696C6C526F774D6574686F644E616D650746696C6C526F77540E0F5461626C65446566696E6974696F6E11535452204E56415243484152284D415829040100000000000FBF391D29518EA56805D6741865195D5A488327155D7C9F9314A742C703EA0281DD9DB405FC7EA9DB659524FED0C3185D45B736E7E2929997C707FB55408246AA564D571CC9B591C7B0213813405CD0BE71D448B0AC6DFFC6E28BF4F92981A8207A70417FB6CDEC0C82D931E3974F186675E99EF2266A52E98777523B7B388700000000D8C8719600000000020000004D000000543A0000541C00000000000000000000000000001000000000000000000000000000000052534453D8DF91A69CD2B84697191C5D79051DCE01000000583A5C4465765C6D7373716C2D72656765785C6F626A5C52656C656173655C417363656E7469732E526567457853514C2E70646200C93A00000000000000000000E33A0000002000000000000000000000000000000000000000000000D53A0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000000000FF2500200010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000100400000000000000000000100434000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000200000000000100020000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00470030000010053007400720069006E006700460069006C00650049006E0066006F0000004C0300000100300030003000300030003400620030000000BC005200010043006F006D006D0065006E0074007300000043006F006C006C0065006300740069006F006E0020006F0066002000520065006700450078002000660075006E006300740069006F006E007300200074006F002000750073006500200069006E0020004D005300530051004C0020002D002000660075006E006300740069006F006E0073002000750073006500200052006500670045007800200043006F006D00700069006C006500640020006D006F0064006500000056001B00010043006F006D00700061006E0079004E0061006D0065000000000041007300630065006E00740069007300200043006F00720070006F0072006100740069006F006E002C00200049006E0063002E00000000003A0009000100460069006C0065004400650073006300720069007000740069006F006E000000000052006500670045007800530051004C0000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00320000004C001600010049006E007400650072006E0061006C004E0061006D006500000041007300630065006E007400690073002E0052006500670045007800530051004C002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200300000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000041007300630065006E007400690073002E0052006500670045007800530051004C002E0064006C006C000000320009000100500072006F0064007500630074004E0061006D0065000000000052006500670045007800530051004C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003200000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000F83A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
DECLARE @hash varbinary(64);

SELECT @hash = HASHBYTES('SHA2_512', @asmBin);

IF EXISTS(SELECT * from sys.trusted_assemblies
	  	  WHERE description = 'Ascentis.RegExSql')
BEGIN
	DECLARE @UnTrustAssembliesCmd nvarchar(max) = '';

	SELECT @UnTrustAssembliesCmd = @UnTrustAssembliesCmd + 'EXEC sys.sp_drop_trusted_assembly @hash = ' + CONVERT(varchar(max), hash, 1) + ';' 
	FROM sys.trusted_assemblies
	WHERE description = 'Ascentis.RegExSql';

	EXEC sp_executesql @UnTrustAssembliesCmd
END

EXEC sys.sp_add_trusted_assembly @hash = @hash, @description = @clrName;

CREATE ASSEMBLY [Ascentis.RegExSQL]
FROM @asmBin
WITH PERMISSION_SET = UNSAFE
GO

CREATE FUNCTION RegExIsMatch( 
  @input nvarchar(max),
  @pattern nvarchar(max)  
)
RETURNS bit EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledIsMatch
GO

CREATE FUNCTION RegExMatch( 
  @input nvarchar(max),
  @pattern nvarchar(max)  
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatch
GO

CREATE FUNCTION RegExMatchIndexed( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @index int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchIndexed
GO

CREATE FUNCTION RegExMatchGroup( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @group int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchGroup
GO

CREATE FUNCTION RegExMatchGroupIndexed( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @group int,
  @index int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchGroupIndexed
GO

CREATE FUNCTION RegExReplace( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @replacement nvarchar(max)
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledReplace
GO

CREATE FUNCTION RegExReplaceCount( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @replacement nvarchar(max),
  @count int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledReplaceCount
GO

CREATE FUNCTION RegExSplit(
	@input nvarchar(max),
	@pattern nvarchar(max)
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledSplit
GO

CREATE FUNCTION RegExEscape(
	@input nvarchar(max)
)
RETURNS NVARCHAR(MAX) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledEscape
GO

CREATE FUNCTION RegExUnescape(
	@input nvarchar(max)
)
RETURNS NVARCHAR(MAX) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledUnescape
GO

CREATE FUNCTION RegExMatches(
	@input nvarchar(max),
	@pattern nvarchar(max)
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatches
GO

CREATE FUNCTION RegExMatchesGroup(
	@input nvarchar(max),
	@pattern nvarchar(max),
	@group int
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchesGroup
GO

CREATE FUNCTION RegExCachedCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCachedCount
GO

CREATE FUNCTION RegExClearCache()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExClearCache
GO

CREATE FUNCTION RegExExecCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExExecCount
GO

CREATE FUNCTION RegExResetExecCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExResetExecCount
GO
