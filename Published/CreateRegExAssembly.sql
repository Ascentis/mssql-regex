/* Source code for the library at: https://github.com/Ascentis/mssql-regex */

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExIsMatch]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExIsMatch
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatch]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatch
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchIndexed]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchIndexed
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExSplit]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExSplit
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExReplace]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExReplace
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExReplaceCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExReplaceCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExEscape]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExEscape
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExUnescape]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExUnescape
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatches]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatches
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchGroup]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchGroup
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchGroupIndexed]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchGroupIndexed
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchesGroup]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchesGroup
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExCachedCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExCachedCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExClearCache]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExClearCache
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExExecCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExExecCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExResetExecCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExResetExecCount
GO

IF EXISTS (select *
	from sys.assembly_files f
	full outer join  sys.assemblies a
		on f.assembly_id=a.assembly_id
	where a.name ='Ascentis.RegExSQL')
	DROP ASSEMBLY [Ascentis.RegExSQL]
GO

IF EXISTS(SELECT *
		  from sys.configurations	
		  where name = 'clr strict security' and value = 0)
	EXEC SP_CONFIGURE 'clr strict security', 1
GO

RECONFIGURE
GO

DECLARE @clrName nvarchar(4000) = 'Ascentis.RegExSql';
DECLARE @asmBin varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300F6C6A0D50000000000000000E00022200B013000001A000000080000000000009E3800000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000A4EE00000300608500001000001000000000100000100000000000001000000000000000000000004B3800004F000000004000006C04000000000000000000000000000000000000006000000C000000C8370000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000A418000000200000001A000000020000000000000000000000000000200000602E727372630000006C0400000040000000060000001C0000000000000000000000000000400000402E72656C6F6300000C00000000600000000200000022000000000000000000000000000040000042000000000000000000000000000000007F38000000000000480000000200050030250000181200000900000000000000000000000000000048370000800000000000000000000000000000000000000000000000000000000000000000000000133004003000000001000011007E02000004027E04000004252D17267E03000004FE0619000006731100000A2580040000046F1200000A0A2B00062A133002003000000002000011007F01000004281300000A260228010000060A0612016F1400000A16FE010C082C08021E731500000A0B070D2B00092A133002001100000001000011000228010000060A06036F1600000A002A4E000302741E000001731700000A81150000012A0000001B3002002500000003000011000328020000060A0006026F1800000A6F1900000A0BDE0B00030628030000060000DC072A00000001100000020008001018000B000000001B3003002100000004000011000328020000060A000602046F1A00000A0BDE0B00030628030000060000DC072A00000001100000020008000C14000B000000001B3004002200000004000011000328020000060A00060204056F1B00000A0BDE0B00030628030000060000DC072A000001100000020008000D15000B000000001B3002002000000005000011000328020000060A0006026F1C00000A0BDE0B00030628030000060000DC072A01100000020008000B13000B00000000133001000C000000060000110002281D00000A0A2B00062A133001000C000000060000110002281E00000A0A2B00062A1B3002002500000004000011000328020000060A0006026F1800000A6F1F00000A0BDE0B00030628030000060000DC072A00000001100000020008001018000B000000001B3002003D00000007000011000328020000060A0006026F2000000A0B04076F2100000A2F0E07046F2200000A6F1F00000A2B0572010000700CDE0B00030628030000060000DC082A00000001100000020008002830000B000000001B3002003000000004000011000328020000060A0006026F1800000A6F2300000A046F2400000A6F1F00000A0BDE0B00030628030000060000DC072A01100000020008001B23000B000000001B3002004800000007000011000328020000060A0006026F2000000A0B05076F2100000A2F1907056F2200000A6F2300000A046F2400000A6F1F00000A2B0572010000700CDE0B00030628030000060000DC082A0110000002000800333B000B000000001B3003004E00000005000011000328020000060A0006026F2000000A280100002B7E05000004252D17267E03000004FE061A000006732600000A258005000004280200002B280300002B0BDE0B00030628030000060000DC072A000001100000020008003941000B000000001B3003004800000008000011731B0000060A06047D06000004000328020000060B0007026F2000000A280100002B06FE061C000006732600000A280200002B280300002B0CDE0B00030728030000060000DC082A0110000002001500263B000B00000000133001001000000009000011007E020000046F2900000A0A2B00062A133001001D0000000A000011007E020000046F2900000A0A7E020000046F2A00000A00060B2B00072A000000133001000D0000000900001100FE137E010000040A2B00062A00000013300100170000000A00001100FE137E010000040A16FE138001000004060B2B00072A2202282B00000A002A2E732C00000A80020000042A2E731800000680030000042A2202282B00000A002A1A732D00000A2A1E036F1F00000A2A2202282B00000A002A5E036F2300000A027B060000046F2400000A6F1F00000A2A00000042534A4201000100000000000C00000076342E302E33303331390000000005006C00000060060000237E0000CC060000C806000023537472696E677300000000940D00000400000023555300980D0000100000002347554944000000A80D00007004000023426C6F62000000000000000200000157150208090A000000FA013300160000010000002300000004000000060000001C000000270000002D000000200000000A000000040000000100000004000000020000000300000000001B04010000000000060016032A05060083032A0506003502F8040F004A05000006005D0241040600F90241040600C502410406006A03410406003603410406004F034104060074024104060049020B05060027020B050600A802410406008F02BC030600D9053A040600A9012A050600A500100606008C0010060A00B40683050E00D6036E050E00E402CC0406009D01A2050A005304830506000C022A0506009E003A040A000204830506001A01AB030A00B50583050600D9033A040A00AE0483050A00F70183050A006304830512009E01BA0406007E00F60000000000C0000000000001000100010010002601000041000100010003211000F20000004100030017000301100048000000410006001B0011005B06E90131009201EE013600BC00FB0116000100FF01160020000C020600B404150250200000000091000D04180201008C20000000009100DE0122020200C820000000009100FF0128020300E520000000009600A2062F020500FC20000000009600F3033702070040210000000096006D013D0209008021000000009600770644020C00C021000000009600E7054C021000FC21000000009600B401B30012001422000000009600C801B30013002C22000000009600E003530214007022000000009600340159021600CC2200000000960082045902190018230000000096004E0160021C007C2300000000960059054C022000E8230000000096009A04680222004C24000000009600660670022500682400000000960082017002250094240000000096004C0670022500B024000000009600380670022500D324000000008618E70406002500DC24000000009118ED0474022500E824000000009118ED0474022500F424000000008618E70406002500FD240000000083000A007802250004250000000083002A00820226000C25000000008618E7040600270015250000000083005E008202270000000100730400000100730400000100730400000200BA0600000100AA0602000200F404000001009C06000002007304000001009C0600000200730400000300FA05000001009C0600000200730400000300FA05000004009106000001009C06000002007304000001009C06000001009C06000001009C06000002007304000001009C0600000200730400000300AE06000001009C0600000200730400000300B404000001009C0600000200730400000300B40400000400AE06000001009C06000002007304000001009C0600000200730400000300B40400000100DB00000001003F04000001003F040900E70401001100E70406001900E7040A002900E70410003100E70410003900E70410004100E70410004900E70410005100E70410005900E70410006100E70415006900E70410007100E70410007900E7041000B100E7040600C900E70406000C00E7042F00140011014100E10006065E001C007B046B00A100E70472001C0008047900A900E7041000A10002048500F900CD058B00A1007A019500A1007A019B00A100F405A900A100C101B300A100D501B3000101A103B800A1006605C400C1002E06CA00C1003104CE00D900C205D40009013104DA0011019706E0002400E7042F001101E005FA001101C0061A0114002E06CA001400C60406008100E70406001400E70406001C00E70406002E000B0088022E00130091022E001B00B0022E002300B9022E002B00C7022E0033001E032E003B0024032E004300B9022E004B0044032E0053001E032E005B001E032E0063005C032E006B0086032E0073009303630083006B04830083006B04A0007B00E103C0007B00E103E0007B00E10300017B00060420017B00E10340017B00E10360017B00E10380017B00E103A0017B00E103C0017B00E103E0017B00060400027B00060420027B00E10340027B00E10360027B00E10380027B00E1031A0050007F008F00A200AF00BC002C0135013901230035006400F200048000000100000000000100010000004701C90000000400000000000000000000003E01E900000000000400000000000000000000003E013A04000000000400000000000000000000003E01DD00000000000400000000000000000000003E01EB010000000003000200040002004B00ED004F001401510028010000003C3E395F5F325F30003C4765745265676578537461636B3E625F5F325F30003C3E395F5F31365F30003C5265674578436F6D70696C65644D6174636865733E625F5F31365F30003C3E635F5F446973706C6179436C61737331375F30003C5265674578436F6D70696C65644D61746368657347726F75703E625F5F300049456E756D657261626C65603100436F6E63757272656E74537461636B60310046756E63603200436F6E63757272656E7444696374696F6E6172796032003C3E39003C4D6F64756C653E00417363656E7469732E526567457853514C005F0053797374656D2E44617461006D73636F726C6962003C3E630053797374656D2E436F6C6C656374696F6E732E47656E65726963004765744F7241646400496E7465726C6F636B6564005265674578436F6D70696C6564005265674578436F6D70696C65644D61746368496E6465786564005265674578436F6D70696C65644D6174636847726F7570496E6465786564005265674578436F6D70696C65645265706C616365005265674578436C656172436163686500526567657843616368650049456E756D657261626C65004973566F6C6174696C65005265674578436F6D70696C6564457363617065005265674578436F6D70696C6564556E657363617065005265676578416371756972650053797374656D2E436F7265004361707475726500526567657852656C6561736500436F6D70696C657247656E65726174656441747472696275746500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C75650053797374656D2E546872656164696E670053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E67005265674578436F6D70696C65644D61746368005265674578436F6D70696C656449734D617463680050757368004765745265676578537461636B00417363656E7469732E526567457853514C2E646C6C006765745F4974656D0053797374656D0053797374656D2E5265666C656374696F6E004D61746368436F6C6C656374696F6E0047726F7570436F6C6C656374696F6E007061747465726E00547279506F70005265674578436F6D70696C65644D6174636847726F7570005265674578436F6D70696C65644D61746368657347726F75700067726F75700053797374656D2E4C696E7100436C656172004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F72007374720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F646573005265674578436F6D70696C65644D6174636865730053797374656D2E446174612E53716C54797065730053797374656D2E546578742E526567756C617245787072657373696F6E730053797374656D2E436F6C6C656374696F6E730052656765784F7074696F6E73006765745F47726F757073006765745F53756363657373004F626A6563740053656C656374005265674578436F6D70696C656453706C6974007265706C6163656D656E7400496E6372656D656E740053797374656D2E436F6C6C656374696F6E732E436F6E63757272656E74006765745F436F756E74005265674578526573657445786563436F756E7400526567457845786563436F756E74005F65786563436F756E74005265674578436163686564436F756E74005265674578436F6D70696C65645265706C616365436F756E7400636F756E74004361737400696E7075740046696C6C526F7700726F7700696E64657800526567657800726567657800546F417272617900000100001BEC9D23BC2D03499054D0BF498C72DF00042001010803200001052001011111042001010E042001010208070115124D0112510B151269020E15124D011251052002011C180B151249020E15124D0112510E20021301130015126902130013010D070415124D01125112510212510500010810080615124D01125106200102101300062002010E1175052001011300050702125102052001126D0E0320000205070212510E0520020E0E0E0620030E0E0E080607021251125D0520011D0E0E0307010E0400010E0E0320000E070703125112610E05200112610E03200008052001126D08052000128085052001127D080C1001011512808D011E00125D040A01126D0715126902126D0E191002021512808D011E011512808D011E00151269021E001E01050A02126D0E0D1001011D1E001512808D011E00030A010E08070312101251125D03070108040702080808B77A5C561934E08980A00024000004800000940000000602000000240000525341310004000001000100FB9E4120118BC09271D4E040E3E458EC36CA202C6BD68AC96BB205FEAB82016B9F0060CF3B7C48FE32D100E6665381CA72EE115798079CB3ABF0C1914FF04590733A8B23E4E5103C532DF7D32E241E4D6170E06675240D008955E661AB9A7DA815D6E3086CE112FF90392E84F58EED4454439083B670906374EFE5B9B1938BB604061F45080C06151249020E15124D0112510306120C0C06151269020E15124D011251080615126902126D0E02060809000115124D0112510E05000112510E060002010E1251070002011C101155050002020E0E0600030E0E0E0E0700040E0E0E0E08060002125D0E0E0500020E0E0E0600030E0E0E080700040E0E0E0808070003125D0E0E08030000080300000109200115124D0112510E0520010E126D0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000701000000000D010008526567457853514C000056010051436F6C6C656374696F6E206F662052656745782066756E6374696F6E7320746F2075736520696E204D5353514C202D2066756E6374696F6E732075736520526567457820436F6D70696C6564206D6F646500000501000000001F01001A417363656E74697320436F72706F726174696F6E2C20496E632E000017010012436F7079726967687420C2A920203230323000002901002433323930653164342D643931642D346635382D623636652D37383936346665333330653600000C010007312E302E302E3100004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E362E310100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E362E31240100020054020F497344657465726D696E69737469630154020949735072656369736501640100040054020F497344657465726D696E69737469630154020949735072656369736501540E1146696C6C526F774D6574686F644E616D650746696C6C526F77540E0F5461626C65446566696E6974696F6E11535452204E56415243484152284D415829040100000051FC51CBDDA9513FF94DD02CAB10F1D61B60967FA0DE9CA1AFD8F553031E5CDC37EA11FDB1018DEA7739D20CE56BE49F2C38677F784F86EC89760E74CFA0671E0DF110F612C0FA1726C5B0429D09FFD5ED796C39AD61D93E38C494DB618316908276E951FF7BC640E5E2D4E693B1E19DF8F4216719CAE9C623BE0C5509BA03370000000052B70DEF00000000020000004B00000000380000001A00000000000000000000000000001000000000000000000000000000000052534453D78EE8EF3FED284EA91DAB3D9D75DDC301000000583A5C4465765C6D7373716C2D72656765785C6F626A5C44656275675C417363656E7469732E526567457853514C2E706462007338000000000000000000008D3800000020000000000000000000000000000000000000000000007F380000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C000000000000FF250020001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000100400000000000000000000100434000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000100000000000100010000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00470030000010053007400720069006E006700460069006C00650049006E0066006F0000004C0300000100300030003000300030003400620030000000BC005200010043006F006D006D0065006E0074007300000043006F006C006C0065006300740069006F006E0020006F0066002000520065006700450078002000660075006E006300740069006F006E007300200074006F002000750073006500200069006E0020004D005300530051004C0020002D002000660075006E006300740069006F006E0073002000750073006500200052006500670045007800200043006F006D00700069006C006500640020006D006F0064006500000056001B00010043006F006D00700061006E0079004E0061006D0065000000000041007300630065006E00740069007300200043006F00720070006F0072006100740069006F006E002C00200049006E0063002E00000000003A0009000100460069006C0065004400650073006300720069007000740069006F006E000000000052006500670045007800530051004C0000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00310000004C001600010049006E007400650072006E0061006C004E0061006D006500000041007300630065006E007400690073002E0052006500670045007800530051004C002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200300000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000041007300630065006E007400690073002E0052006500670045007800530051004C002E0064006C006C000000320009000100500072006F0064007500630074004E0061006D0065000000000052006500670045007800530051004C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003100000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0031000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000A03800000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
DECLARE @hash varbinary(64);

SELECT @hash = HASHBYTES('SHA2_512', @asmBin);

IF EXISTS(SELECT * from sys.trusted_assemblies
	  	  WHERE description = 'Ascentis.RegExSql')
BEGIN
	DECLARE @UnTrustAssembliesCmd nvarchar(max);

	SELECT @UnTrustAssembliesCmd = 'EXEC sys.sp_drop_trusted_assembly @hash = ' + CONVERT(varchar(max), hash, 1) + ';' 
	FROM sys.trusted_assemblies
	WHERE description = 'Ascentis.RegExSql';

	EXEC sp_executesql @UnTrustAssembliesCmd
END

EXEC sys.sp_add_trusted_assembly @hash = @hash, @description = @clrName;

CREATE ASSEMBLY [Ascentis.RegExSQL]
FROM @asmBin
WITH PERMISSION_SET = UNSAFE
GO

CREATE FUNCTION RegExIsMatch( 
  @input nvarchar(max),
  @pattern nvarchar(max)  
)
RETURNS bit EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledIsMatch
GO

CREATE FUNCTION RegExMatch( 
  @input nvarchar(max),
  @pattern nvarchar(max)  
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatch
GO

CREATE FUNCTION RegExMatchIndexed( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @index int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchIndexed
GO

CREATE FUNCTION RegExMatchGroup( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @group int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchGroup
GO

CREATE FUNCTION RegExMatchGroupIndexed( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @group int,
  @index int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchGroupIndexed
GO

CREATE FUNCTION RegExReplace( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @replacement nvarchar(max)
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledReplace
GO

CREATE FUNCTION RegExReplaceCount( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @replacement nvarchar(max),
  @count int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledReplaceCount
GO

CREATE FUNCTION RegExSplit(
	@input nvarchar(max),
	@pattern nvarchar(max)
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledSplit
GO

CREATE FUNCTION RegExEscape(
	@input nvarchar(max)
)
RETURNS NVARCHAR(MAX) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledEscape
GO

CREATE FUNCTION RegExUnescape(
	@input nvarchar(max)
)
RETURNS NVARCHAR(MAX) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledUnescape
GO

CREATE FUNCTION RegExMatches(
	@input nvarchar(max),
	@pattern nvarchar(max)
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatches
GO

CREATE FUNCTION RegExMatchesGroup(
	@input nvarchar(max),
	@pattern nvarchar(max),
	@group int
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchesGroup
GO

CREATE FUNCTION RegExCachedCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCachedCount
GO

CREATE FUNCTION RegExClearCache()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExClearCache
GO

CREATE FUNCTION RegExExecCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExExecCount
GO

CREATE FUNCTION RegExResetExecCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExResetExecCount
GO
