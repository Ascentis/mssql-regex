/* Source code for the library at: https://github.com/Ascentis/mssql-regex */

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExIsMatch]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExIsMatch
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatch]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatch
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchIndexed]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchIndexed
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExSplit]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExSplit
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExReplace]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExReplace
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExReplaceCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExReplaceCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExEscape]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExEscape
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExUnescape]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExUnescape
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatches]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatches
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchGroup]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchGroup
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchGroupIndexed]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchGroupIndexed
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExMatchesGroup]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExMatchesGroup
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExCachedCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExCachedCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExClearCache]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExClearCache
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExExecCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExExecCount
GO

IF EXISTS (SELECT *
           FROM   sys.objects
           WHERE  object_id = OBJECT_ID(N'[dbo].[RegExResetExecCount]')
                  AND type IN ( N'FN', N'IF', N'TF', N'FS', N'FT' ))
	DROP FUNCTION RegExResetExecCount
GO

IF EXISTS (select *
	from sys.assembly_files f
	full outer join  sys.assemblies a
		on f.assembly_id=a.assembly_id
	where a.name ='Ascentis.RegExSQL')
	DROP ASSEMBLY [Ascentis.RegExSQL]
GO

IF EXISTS(SELECT *
		  from sys.configurations	
		  where name = 'clr strict security' and value = 0)
	EXEC SP_CONFIGURE 'clr strict security', 1
GO

RECONFIGURE
GO

DECLARE @clrName nvarchar(4000) = 'Ascentis.RegExSql';
DECLARE @asmBin varbinary(max) = 0x4D5A90000300000004000000FFFF0000B800000000000000400000000000000000000000000000000000000000000000000000000000000000000000800000000E1FBA0E00B409CD21B8014CCD21546869732070726F6772616D2063616E6E6F742062652072756E20696E20444F53206D6F64652E0D0D0A2400000000000000504500004C010300A79319E50000000000000000E00022200B013000001C000000080000000000002E3A00000020000000400000000000100020000000020000040000000000000006000000000000000080000000020000EA9B0000030060850000100000100000000010000010000000000000100000000000000000000000D93900004F000000004000006C04000000000000000000000000000000000000006000000C00000054390000380000000000000000000000000000000000000000000000000000000000000000000000000000000000000000200000080000000000000000000000082000004800000000000000000000002E74657874000000341A000000200000001C000000020000000000000000000000000000200000602E727372630000006C0400000040000000060000001E0000000000000000000000000000400000402E72656C6F6300000C00000000600000000200000024000000000000000000000000000040000042000000000000000000000000000000000D3A0000000000004800000002000500642500007013000009000000000000000000000000000000D43800008000000000000000000000000000000000000000000000000000000000000000000000005A16731100000A8001000004731200000A80020000042A001330020026000000010000117F03000004281300000A260228030000060A0612016F1400000A2D08020673160000060B072A00001B3003003E00000002000011160B7F010000041201281500000A7E020000040212006F1600000A2D12731700000A0A7E0200000402066F1800000ADE0B7F01000004281900000ADC062A00000110000002000E002331000B000000004A03027421000001731A00000A81150000012A001B30020022000000030000110328020000060A06026F1B00000A6F1C00000A0BDE0A062C06066F1D00000ADC072A000001100000020007000F16000A000000001B3003001E000000040000110328020000060A0602046F1E00000A0BDE0A062C06066F1D00000ADC072A000001100000020007000B12000A000000001B3004001F000000040000110328020000060A060204056F1F00000A0BDE0A062C06066F1D00000ADC072A0001100000020007000C13000A000000001B3002001D000000050000110328020000060A06026F2000000A0BDE0A062C06066F1D00000ADC072A00000001100000020007000A11000A000000001E02282100000A2A1E02282200000A2A1B30020022000000040000110328020000060A06026F1B00000A6F2300000A0BDE0A062C06066F1D00000ADC072A000001100000020007000F16000A000000001B3002003A000000060000110328020000060A06026F2400000A0B04076F2500000A2F0E07046F2600000A6F2300000A2B0572010000700CDE0A062C06066F1D00000ADC082A00000110000002000700272E000A000000001B3002002D000000040000110328020000060A06026F1B00000A6F2700000A046F2800000A6F2300000A0BDE0A062C06066F1D00000ADC072A00000001100000020007001A21000A000000001B30020045000000060000110328020000060A06026F2400000A0B05076F2500000A2F1907056F2600000A6F2700000A046F2800000A6F2300000A2B0572010000700CDE0A062C06066F1D00000ADC082A00000001100000020007003239000A000000001B3003004B000000050000110328020000060A06026F2400000A280100002B7E06000004252D17267E05000004FE061A000006732A00000A258006000004280200002B280300002B0BDE0A062C06066F1D00000ADC072A000110000002000700383F000A000000001B3003004500000007000011731C0000060A06047D080000040328020000060B07026F2400000A280100002B06FE061D000006732A00000A280200002B280300002B0CDE0A072C06076F1D00000ADC082A00000001100000020014002539000A000000001B3003004700000008000011160A7F010000041200281500000A7E020000047E07000004252D17267E05000004FE061B000006732D00000A258007000004280400002B0BDE0B7F01000004281900000ADC072A000110000002000E002C3A000B000000001B30020032000000090000117E020000046F2F00000A0A160B7F010000041201281500000A7E020000046F3000000ADE0B7F01000004281900000ADC062A000001100000020019000C25000B0000000022FE137E030000042A42FE137E0300000416FE1380030000042A1E02283100000A2A4202031E283200000A02047D040000042A36027B04000004026F3300000A2A2E731900000680050000042A1E02283100000A2A1E036F2300000A2A360F01283400000A6F3500000A2A1E02283100000A2A5E036F2700000A027B080000046F2800000A6F2300000A2A0042534A4201000100000000000C00000076342E302E33303331390000000005006C000000EC060000237E0000580700002007000023537472696E677300000000780E000004000000235553007C0E00001000000023475549440000008C0E0000E404000023426C6F62000000000000000200000157170208090A000000FA013300160000010000002800000005000000080000001D0000002700000001000000350000002000000009000000070000000100000004000000030000000400000000005A04010000000000060024037D05060091037D05060043024B050F009D05000006006B028E04060007038E040600D3028E04060078038E04060044038E0406005D038E04060082028E04060057025E05060035025E050600B6028E0406009D02D60306002C06830406005104C5030600C7000D010600910068060600BC017D050A00F003C1050A00F2021F050600A401F5050E00A004D6050E001207D6050600B001830406001A027D050600B10083040E001C04D6050600B8000D010600C8000D0106002C01C5030600F30383040E00FB04D6050E000A02D6050E00B004D6051200A5010705060083000D010600A3000D010E000806D60500000000D90000000000010001000100000038010000410001000100040010000C0700006500040016000321100009010000410005001800030110004D000000410008001C001100420442023100700446021100B306530221003B0458023600D5006002160025006402160001006D02060001057F0250200000000091184005820201006820000000009400F101860201009C2000000000910027048C020200F820000000009600FA06960203000C210000000096000D049E0205004C210000000096007F01A40207008821000000009600CF06AB020A00C4210000000096003A06B3020E000022000000009600C701A20010000822000000009600DB01A20011001022000000009600FA03BA02120050220000000096004601C0021400A822000000009600CF04C0021700F4220000000096006001C7021A005823000000009600AC05B3021E00C023000000009600E704CF0220002424000000009600BE06D702230088240000000096009401D7022300D824000000009600A406D7022300E1240000000096009006D7022300F2240000000086183A0506002300FA240000000083183A05DB0223000B2500000000E601120206002500192500000000911840058202250025250000000086183A05060025002D250000000083002F00E602250035250000000083000B00EC02260043250000000086183A05060027004B250000000083006300E602270000000100C00400000100C00400000100020702000200470500000100F40600000200C00400000100F40600000200C00400000300520600000100F40600000200C00400000300520600000400E90600000100F40600000200C00400000100F40600000100F40600000100F40600000200C00400000100F40600000200C00400000300060700000100F40600000200C00400000300010500000100F40600000200C00400000300010500000400060700000100F40600000200C00400000100F40600000200C00400000300010500000100C004000002003C04000001008C04000001003C04000001008C040300690009003A05010011003A05060019003A050A0029003A05100031003A05100039003A05100041003A05100049003A05100051003A05100059003A05100061003A05150069003A05100071003A05100079003A051000B1003A050600D9003A05060089003A0515000C003A05060001015E0631001400C8043E00890019054F001C00B903610014003A0506001C0028016A0089004D060600A9003A051000C9001C047800110120067E00D10012020600C9008C018800C9008C018E00C90047069C00C900D401A200C900E801A2001901AF03A700C900B905B300C1008606B900C1007A04BD00E9001506C30021017A04C9002901EF06D00024003A05EA0029013306F0002901180710012C003A05EA0029018A04410134008606B90034001305060081003A050600C9003A0578011400220480013C00AF03920114008606B9002E000B00FB022E00130004032E001B0023032E0023002C032E002B003A032E00330091032E003B0097032E0043002C032E004B00B7032E00530091032E005B0091032E006300CF032E006B00F9032E007300060483008300DE04A0007B005404A3008300DE04C0007B005404E0007B00540400017B00790420017B00540440017B00540460017B00540480017B005404A0017B005404C0017B005404E0017B00790400027B00790420027B00540440027B00540460027B00540480027B00540426004500720082009500AB0022012B0162011A0037005500E20030016701860104800000010000000000020001000000A001E200000004000000000000000000000097010001000000000400000000000000000000009701F4000000000004000000000000000000000097018304000000000400000000000000000000009701FE01000000000300020004000200050002005300DD0057000A0159001E015D00540100000000003C3E395F5F32305F30003C5265674578436163686564436F756E743E625F5F32305F30003C3E395F5F31385F30003C5265674578436F6D70696C65644D6174636865733E625F5F31385F30003C3E635F5F446973706C6179436C61737331395F30003C5265674578436F6D70696C65644D61746368657347726F75703E625F5F300049456E756D657261626C65603100436F6E63757272656E74537461636B60310049436F6C6C656374696F6E60310046756E636032004B657956616C7565506169726032004944696374696F6E6172796032003C3E39003C4D6F64756C653E00417363656E7469732E526567457853514C0053797374656D2E44617461006D73636F726C6962003C3E630053797374656D2E436F6C6C656374696F6E732E47656E657269630041646400496E7465726C6F636B6564005265674578436F6D70696C6564005265674578436F6D70696C65644D61746368496E6465786564005265674578436F6D70696C65644D6174636847726F7570496E6465786564005265674578436F6D70696C65645265706C616365005265674578436C65617243616368650049456E756D657261626C650049446973706F7361626C65004973566F6C6174696C65005265674578436F6D70696C6564457363617065005265674578436F6D70696C6564556E657363617065005265676578416371756972650053797374656D2E436F7265004361707475726500446973706F736500436F6D70696C657247656E65726174656441747472696275746500477569644174747269627574650044656275676761626C6541747472696275746500436F6D56697369626C6541747472696275746500417373656D626C795469746C6541747472696275746500417373656D626C7954726164656D61726B417474726962757465005461726765744672616D65776F726B41747472696275746500417373656D626C7946696C6556657273696F6E41747472696275746500417373656D626C79436F6E66696775726174696F6E4174747269627574650053716C46756E6374696F6E41747472696275746500417373656D626C794465736372697074696F6E41747472696275746500436F6D70696C6174696F6E52656C61786174696F6E7341747472696275746500417373656D626C7950726F6475637441747472696275746500417373656D626C79436F7079726967687441747472696275746500417373656D626C79436F6D70616E794174747269627574650052756E74696D65436F6D7061746962696C697479417474726962757465006765745F56616C75650054727947657456616C75650053797374656D2E546872656164696E670053797374656D2E52756E74696D652E56657273696F6E696E670053716C537472696E67005265674578436F6D70696C65644D61746368005265674578436F6D70696C656449734D61746368005075736800476574506F6F6C65645265676578537461636B005F737461636B005F7265676578506F6F6C4C6F636B005370696E4C6F636B00417363656E7469732E526567457853514C2E646C6C005265676578506F6F6C006765745F4974656D0053797374656D0053756D0053797374656D2E5265666C656374696F6E004D61746368436F6C6C656374696F6E0047726F7570436F6C6C656374696F6E007061747465726E00547279506F70005265674578436F6D70696C65644D6174636847726F7570005265674578436F6D70696C65644D61746368657347726F75700067726F75700053797374656D2E4C696E7100436C65617200456E746572004D6963726F736F66742E53716C5365727665722E536572766572002E63746F72002E6363746F72007374720053797374656D2E446961676E6F73746963730053797374656D2E52756E74696D652E496E7465726F7053657276696365730053797374656D2E52756E74696D652E436F6D70696C6572536572766963657300446562756767696E674D6F646573005265674578436F6D70696C65644D6174636865730053797374656D2E446174612E53716C54797065730053797374656D2E546578742E526567756C617245787072657373696F6E730053797374656D2E436F6C6C656374696F6E730052656765784F7074696F6E73006765745F47726F757073006765745F53756363657373004F626A6563740053656C656374005265674578436F6D70696C656453706C69740045786974007265706C6163656D656E7400496E6372656D656E740053797374656D2E436F6C6C656374696F6E732E436F6E63757272656E74006765745F436F756E74005265674578526573657445786563436F756E7400526567457845786563436F756E74005F65786563436F756E74005265674578436163686564436F756E74005265674578436F6D70696C65645265706C616365436F756E7400636F756E74004361737400696E7075740046696C6C526F7700726F7700696E64657800506F6F6C6564526567657800546F4172726179000001000094539DBA0767A74B834AC611BCB4A70D00042001010803200001052001011111042001010E04200101020B15127D020E15124D01120C0A070215124D01120C120C0500010810080615124D01120C0620010210130009070215124D01120C020520010110020B151249020E15124D01120C0820020213001013010720020113001301050702120C0205200112750E03200002050702120C0E0520020E0E0E0620030E0E0E08060702120C125D0520011D0E0E0400010E0E0320000E070703120C12610E05200112610E03200008052001127508052000128091062001128089080C10010115128099011E00125D040A011275071512710212750E052002011C181910020215128099011E0115128099011E00151271021E001E01050A0212750E0D1001011D1E0015128099011E00030A010E0807031214120C125D04070202081015127102151179020E15124D01120C08121001020815128099011E00151271021E00080D0A01151179020E15124D01120C0407020802101512809D01151179020E15124D01120C072002010E1180A10520010113000B151179020E15124D01120C042000130108B77A5C561934E08980A00024000004800000940000000602000000240000525341310004000001000100FB9E4120118BC09271D4E040E3E458EC36CA202C6BD68AC96BB205FEAB82016B9F0060CF3B7C48FE32D100E6665381CA72EE115798079CB3ABF0C1914FF04590733A8B23E4E5103C532DF7D32E241E4D6170E06675240D008955E661AB9A7DA815D6E3086CE112FF90392E84F58EED4454439083B670906374EFE5B9B1938BB6030611450C06151249020E15124D01120C04061F5108070615124D01120C0306121008061512710212750E110615127102151179020E15124D01120C0802060803000001050001120C0E09000115124D01120C0E070002011C101155050002020E0E0600030E0E0E0E0700040E0E0E0E08060002125D0E0E0500020E0E0E0600030E0E0E080700040E0E0E0808070003125D0E0E08030000080A2002010E15124D01120C0520010E12750E200108151179020E15124D01120C0801000800000000001E01000100540216577261704E6F6E457863657074696F6E5468726F7773010801000200000000000D010008526567457853514C000056010051436F6C6C656374696F6E206F662052656745782066756E6374696F6E7320746F2075736520696E204D5353514C202D2066756E6374696F6E732075736520526567457820436F6D70696C6564206D6F646500000501000000001F01001A417363656E74697320436F72706F726174696F6E2C20496E632E000017010012436F7079726967687420C2A920203230323000002901002433323930653164342D643931642D346635382D623636652D37383936346665333330653600000C010007312E302E302E3200004D01001C2E4E45544672616D65776F726B2C56657273696F6E3D76342E362E310100540E144672616D65776F726B446973706C61794E616D65142E4E4554204672616D65776F726B20342E362E31240100020054020F497344657465726D696E69737469630154020949735072656369736501640100040054020F497344657465726D696E69737469630154020949735072656369736501540E1146696C6C526F774D6574686F644E616D650746696C6C526F77540E0F5461626C65446566696E6974696F6E11535452204E56415243484152284D4158290401000000004E2CB246365DF2F5833B16494C82CE48D21C270772F1E7FEC1FAE8D2CE2FBF82DE723D146491D5BFF42BF89A424C79A7B679B94C34DF4092EF38F2AAD70DB83F42EAAAC879988352A9219BB6F51C694F4312434427ED32C885750FFB5E3139F2E351046C9D453F7BBAB453973E6CF5860559A885EC5B947628436FE6A2DB884C00000000E066F2D700000000020000004D0000008C3900008C1B00000000000000000000000000001000000000000000000000000000000052534453DEF16C41585C7B44A767346C0CEBD7A801000000583A5C4465765C6D7373716C2D72656765785C6F626A5C52656C656173655C417363656E7469732E526567457853514C2E70646200013A000000000000000000001B3A00000020000000000000000000000000000000000000000000000D3A0000000000000000000000005F436F72446C6C4D61696E006D73636F7265652E646C6C0000000000000000FF25002000100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000100100000001800008000000000000000000000000000000100010000003000008000000000000000000000000000000100000000004800000058400000100400000000000000000000100434000000560053005F00560045005200530049004F004E005F0049004E0046004F0000000000BD04EFFE00000100000001000200000000000100020000003F000000000000000400000002000000000000000000000000000000440000000100560061007200460069006C00650049006E0066006F00000000002400040000005400720061006E0073006C006100740069006F006E00000000000000B00470030000010053007400720069006E006700460069006C00650049006E0066006F0000004C0300000100300030003000300030003400620030000000BC005200010043006F006D006D0065006E0074007300000043006F006C006C0065006300740069006F006E0020006F0066002000520065006700450078002000660075006E006300740069006F006E007300200074006F002000750073006500200069006E0020004D005300530051004C0020002D002000660075006E006300740069006F006E0073002000750073006500200052006500670045007800200043006F006D00700069006C006500640020006D006F0064006500000056001B00010043006F006D00700061006E0079004E0061006D0065000000000041007300630065006E00740069007300200043006F00720070006F0072006100740069006F006E002C00200049006E0063002E00000000003A0009000100460069006C0065004400650073006300720069007000740069006F006E000000000052006500670045007800530051004C0000000000300008000100460069006C006500560065007200730069006F006E000000000031002E0030002E0030002E00320000004C001600010049006E007400650072006E0061006C004E0061006D006500000041007300630065006E007400690073002E0052006500670045007800530051004C002E0064006C006C0000004800120001004C006500670061006C0043006F007000790072006900670068007400000043006F0070007900720069006700680074002000A90020002000320030003200300000002A00010001004C006500670061006C00540072006100640065006D00610072006B00730000000000000000005400160001004F0072006900670069006E0061006C00460069006C0065006E0061006D006500000041007300630065006E007400690073002E0052006500670045007800530051004C002E0064006C006C000000320009000100500072006F0064007500630074004E0061006D0065000000000052006500670045007800530051004C0000000000340008000100500072006F006400750063007400560065007200730069006F006E00000031002E0030002E0030002E003200000038000800010041007300730065006D0062006C0079002000560065007200730069006F006E00000031002E0030002E0030002E0032000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003000000C000000303A00000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000;
DECLARE @hash varbinary(64);

SELECT @hash = HASHBYTES('SHA2_512', @asmBin);

IF EXISTS(SELECT * from sys.trusted_assemblies
	  	  WHERE description = 'Ascentis.RegExSql')
BEGIN
	DECLARE @UnTrustAssembliesCmd nvarchar(max) = '';

	SELECT @UnTrustAssembliesCmd = @UnTrustAssembliesCmd + 'EXEC sys.sp_drop_trusted_assembly @hash = ' + CONVERT(varchar(max), hash, 1) + ';' 
	FROM sys.trusted_assemblies
	WHERE description = 'Ascentis.RegExSql';

	EXEC sp_executesql @UnTrustAssembliesCmd
END

EXEC sys.sp_add_trusted_assembly @hash = @hash, @description = @clrName;

CREATE ASSEMBLY [Ascentis.RegExSQL]
FROM @asmBin
WITH PERMISSION_SET = UNSAFE
GO

CREATE FUNCTION RegExIsMatch( 
  @input nvarchar(max),
  @pattern nvarchar(max)  
)
RETURNS bit EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledIsMatch
GO

CREATE FUNCTION RegExMatch( 
  @input nvarchar(max),
  @pattern nvarchar(max)  
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatch
GO

CREATE FUNCTION RegExMatchIndexed( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @index int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchIndexed
GO

CREATE FUNCTION RegExMatchGroup( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @group int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchGroup
GO

CREATE FUNCTION RegExMatchGroupIndexed( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @group int,
  @index int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchGroupIndexed
GO

CREATE FUNCTION RegExReplace( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @replacement nvarchar(max)
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledReplace
GO

CREATE FUNCTION RegExReplaceCount( 
  @input nvarchar(max),
  @pattern nvarchar(max),
  @replacement nvarchar(max),
  @count int
)
RETURNS nvarchar(max) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledReplaceCount
GO

CREATE FUNCTION RegExSplit(
	@input nvarchar(max),
	@pattern nvarchar(max)
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledSplit
GO

CREATE FUNCTION RegExEscape(
	@input nvarchar(max)
)
RETURNS NVARCHAR(MAX) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledEscape
GO

CREATE FUNCTION RegExUnescape(
	@input nvarchar(max)
)
RETURNS NVARCHAR(MAX) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledUnescape
GO

CREATE FUNCTION RegExMatches(
	@input nvarchar(max),
	@pattern nvarchar(max)
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatches
GO

CREATE FUNCTION RegExMatchesGroup(
	@input nvarchar(max),
	@pattern nvarchar(max),
	@group int
)
RETURNS TABLE (ITEM NVARCHAR(MAX)) EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCompiledMatchesGroup
GO

CREATE FUNCTION RegExCachedCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExCachedCount
GO

CREATE FUNCTION RegExClearCache()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExClearCache
GO

CREATE FUNCTION RegExExecCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExExecCount
GO

CREATE FUNCTION RegExResetExecCount()
RETURNS INT EXTERNAL NAME [Ascentis.RegExSQL].RegExCompiled.RegExResetExecCount
GO
